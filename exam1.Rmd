---
title: "Exam 1"
author: "Lilly Clark"
date: "03-06-20"
output: 
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = NA, 
                      message = FALSE, warning = FALSE)
```

## Packages

```{r packages}
library(tidyverse)
library(purrr)
library(dplyr)
library(lubridate)
library(stringr)
```

## Data

```{r load-data}
tdf <- readRDS(file = "data/tdf_2019.rds")
```

Use object tdf to create a tidy data frame called tdf_clean that contains the following variables. Each variable should be of the specified type given in parentheses.

stage - stage of the Tour (integer)
rider_name - full name of the cyclist, no need to change the format (character)
rider_nat - cyclist's nationality (character)
team_name - cyclist's team name (character)
team_nat - cyclist's team nationality (character)
dep_city - departure city for given stage (character)
arr_city - arrival city for given stage (character)
classification - stage's classification (character)
distance - stage's distance that cyclists will ride (double)
start_date - stage's start date, not the time (date)
time - cyclist's time or relative time on a given stage (character)
time_rank - rank of cyclist as given in the stage (integer)
sprint_pts - sprint points earned by cyclist on given stage (double)
sprint_rank - rank of cyclist based on sprint points within stage (integer)
climb_pts - climb points earned by cyclist on given stage (double)
climb_rank - rank of cyclist based on climb points within stage (integer)
young_rider_time - young rider time on a given stage (character)
young_rider_rank - rank of cyclist based on young rider time within stage (integer)
If a variable's value is missing, code it as NA. For example, some cyclists may have values dns, dnf, or dq if they did not start, did not finish, or were disqualified, respectively. Similarly, most riders will not have climb points and a climb rank since only a few points are up for grabs in a given stage; riders missing these values should also have NA for the respective variable's value.


### Task 1

```{r harvest-stage-info}
compile_stage <- function(n){
  stage_info <- data.frame(tdf[[n]]$stage) %>%
    select(description:single_event)
  
  people <- lapply(tdf[[n]]$stage$competitors, data.frame) %>%
    bind_rows() %>%
    mutate(description = (str_c("Stage ", n)))
  
  team_info <- lapply(tdf[[n]]$stage$teams, data.frame) %>%
    bind_rows() %>%
    rename(team.id = id)
  
  people_teams <- full_join(people, team_info, by = "team.id")
  
  whole_stage <- full_join(people_teams, stage_info, by = "description") 

  return (whole_stage)
}

messy_tdf <- lapply(1:21, compile_stage) %>%
  rbind_list()
```

```{r rename-relevant-variables}
messy_tdf <- messy_tdf %>%
  select(stage = description, rider_name = name.x, rider_nat = nationality.x, team_name = team.name, team_nat = team.nationality, dep_city = departure_city, arr_city = arrival_city, classification, distance, start_date = scheduled, time = result.time, time_rank = result.time_ranking, team_time = result.team_time, team_rank = result.team_time_ranking, sprint_pts = result.sprint, sprint_rank = result.sprint_ranking, climb_pts = result.climber, climb_rank = result.climber_ranking, young_rider_time = result.young_rider, young_rider_rank = result.young_rider_ranking, dns, dnf, dsq)
#keeping dns dnf dsq for now
```

```{r correct-variable-types}
messy_tdf <- messy_tdf %>%
  mutate(stage = as.integer(str_extract(stage, "\\d.*")),
         distance = as.numeric(str_replace(distance, ",", ".")), 
         start_date = date(str_extract(start_date, "\\d{4}-\\d{2}-\\d{2}")),
         time_rank = as.integer(time_rank), 
         sprint_pts = as.numeric(sprint_pts),
         sprint_rank = as.integer(sprint_rank),
         climb_pts = as.numeric(climb_pts),
         climb_rank = as.integer(climb_rank),
         young_rider_rank = as.integer(young_rider_rank)
         )

tdf_clean <- messy_tdf %>%
  select(-team_time, -team_rank)
```

-dns, -dnf, -dsq,

```{r}
tdf_clean
```

```{r working-w-nas}
names <- tdf_clean %>%
  filter(is.na(time), stage != 2, stage != 19) %>%
  distinct(rider_name)
names

tdf_clean %>%
  filter(rider_name == "Bevin, Patrick")
```

```{r save-to-file}
saveRDS(tdf_clean, "results/tdf_clean.rds")
```

